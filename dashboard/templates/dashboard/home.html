{% extends 'base.html' %}
{% block content %}

<div class="p-6 space-y-10">

  <!-- 🌅 البطاقة الترحيبية -->
  <div id="greetingCard"
       class="relative overflow-hidden rounded-3xl border border-gray-200 shadow bg-gradient-to-r from-blue-50 to-blue-100 p-6 flex items-center justify-between transition-all duration-500">

    <div class="space-y-1">
      <h1 id="greetingText" class="text-2xl font-bold text-gray-800">
        مرحباً {{ request.user.first_name|default:request.user.username }} 👋
      </h1>
      <p id="dateText" class="text-gray-600"></p>
      <p class="text-gray-500 text-sm italic mt-1" id="quoteText">
        نتمنى لك يوماً مثمرًا في إدارة العيادة 👨‍⚕️
      </p>
    </div>

    <div id="iconArea" class="text-6xl text-yellow-400 transition-transform duration-500">☀️</div>
  </div>

  <!-- 📊 البطاقات -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-5">
    <div class="bg-white border border-gray-200 shadow rounded-2xl p-5 hover:shadow-lg transition">
      <p class="text-sm text-gray-500 mb-1">👨‍⚕️ المرضى</p>
      <h2 class="text-3xl font-bold text-blue-700">{{ total_patients }}</h2>
      <p class="text-xs text-gray-500 mt-1">+{{ today_patients }} اليوم</p>
    </div>

    <div class="bg-white border border-gray-200 shadow rounded-2xl p-5 hover:shadow-lg transition">
      <p class="text-sm text-gray-500 mb-1">📅 المواعيد</p>
      <h2 class="text-3xl font-bold text-emerald-700">{{ total_appointments }}</h2>
      <p class="text-xs text-gray-500 mt-1">+{{ recent_appointments }} آخر 24 ساعة</p>
    </div>

    <div class="bg-white border border-gray-200 shadow rounded-2xl p-5 hover:shadow-lg transition">
      <p class="text-sm text-gray-500 mb-1">💰 الفواتير</p>
      <h2 class="text-3xl font-bold text-green-700">{{ total_invoices|floatformat:0 }} IQD</h2>
      <p class="text-xs text-gray-500 mt-1">+{{ this_week_invoices|floatformat:0 }} هذا الأسبوع</p>
    </div>

    <div class="bg-white border border-gray-200 shadow rounded-2xl p-5 hover:shadow-lg transition">
      <p class="text-sm text-gray-500 mb-1">👥 المستخدمون</p>
      <h2 class="text-3xl font-bold text-indigo-700">{{ users_count }}</h2>
      <p class="text-xs text-gray-500 mt-1">المسجلون في النظام</p>
    </div>
  </div>

  <!-- 🧾 آخر المرضى -->
  <div class="bg-white rounded-2xl shadow border border-gray-200 mt-8">
    <div class="flex justify-between items-center border-b px-6 py-3 bg-gray-50">
      <h2 class="font-semibold text-gray-700">🧾 آخر المرضى المسجلين</h2>
      <a href="{% url 'patients:list' %}" class="text-blue-600 text-sm hover:underline">عرض الكل</a>
    </div>

    <table class="min-w-full text-sm text-left">
      <thead class="bg-gray-100 text-gray-700 uppercase text-xs">
        <tr>
          <th class="px-6 py-3">الاسم</th>
          <th class="px-6 py-3">العمر</th>
          <th class="px-6 py-3">تاريخ التسجيل</th>
          <th class="px-6 py-3 text-right">الإجراء</th>
        </tr>
      </thead>
      <tbody>
        {% for p in recent_patients %}
        <tr class="border-b hover:bg-gray-50 transition">
          <td class="px-6 py-3">{{ p.name }}</td>
          <td class="px-6 py-3">{{ p.age }}</td>
          <td class="px-6 py-3">{{ p.created_at|date:"d F Y" }}</td>
          <td class="px-6 py-3 text-right">
            <a href="{% url 'patients:detail' p.id %}" class="text-blue-600 hover:underline">عرض</a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="4" class="text-center py-6 text-gray-500">لا يوجد مرضى بعد</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- 🌞 سكريبت الترحيب -->
<script>
  function updateGreeting() {
    const now = new Date();
    const hour = now.getHours();
    const minutes = now.getMinutes().toString().padStart(2, '0');

    const isMorning = hour >= 5 && hour < 12;
    const isEvening = hour >= 18 || hour < 5;

    const greetingText = document.getElementById("greetingText");
    const dateText = document.getElementById("dateText");
    const iconArea = document.getElementById("iconArea");
    const quoteText = document.getElementById("quoteText");
    const card = document.getElementById("greetingCard");

    const days = ["الأحد", "الإثنين", "الثلاثاء", "الأربعاء", "الخميس", "الجمعة", "السبت"];
    const months = ["يناير", "فبراير", "مارس", "أبريل", "مايو", "يونيو", "يوليو", "أغسطس", "سبتمبر", "أكتوبر", "نوفمبر", "ديسمبر"];

    const todayStr = `${days[now.getDay()]}، ${now.getDate()} ${months[now.getMonth()]} ${now.getFullYear()} — ${hour}:${minutes}`;
    dateText.textContent = todayStr;

    if (isMorning) {
      greetingText.textContent = `🌅 صباح الخير، {{ request.user.first_name|default:request.user.username }}!`;
      iconArea.textContent = "☀️";
      card.className = "relative overflow-hidden rounded-3xl border border-yellow-200 shadow bg-gradient-to-r from-yellow-50 to-blue-50 p-6 flex items-center justify-between transition-all";
      quoteText.textContent = "نتمنى لك يومًا مثمرًا ومليئًا بالنشاط 👨‍⚕️";
    } else if (isEvening) {
      greetingText.textContent = `🌙 مساء الخير، {{ request.user.first_name|default:request.user.username }}!`;
      iconArea.textContent = "🌙";
      card.className = "relative overflow-hidden rounded-3xl border border-gray-300 shadow bg-gradient-to-r from-blue-100 to-gray-200 p-6 flex items-center justify-between transition-all";
      quoteText.textContent = "نتمنى لك أمسية هادئة بعد يوم مليء بالعمل 🌙";
    } else {
      greetingText.textContent = `👋 أهلاً، {{ request.user.first_name|default:request.user.username }}!`;
      iconArea.textContent = "☁️";
      card.className = "relative overflow-hidden rounded-3xl border border-gray-200 shadow bg-gradient-to-r from-blue-50 to-gray-50 p-6 flex items-center justify-between transition-all";
      quoteText.textContent = "استمر في إنجازاتك 💪";
    }
  }

  updateGreeting();
  setInterval(updateGreeting, 60000);
</script>

{% endblock %}
