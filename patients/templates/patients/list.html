{% extends 'base.html' %}
{% load static %}
{% block content %}

<div x-data="patientsList()" x-init="init()" class="p-6 max-w-6xl mx-auto">

  <!-- ğŸ§­ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† + Ø²Ø± Ø§Ù„Ø¥Ø¶Ø§ÙØ© -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-6">
    <h1 class="text-2xl font-bold text-gray-800">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø±Ø¶Ù‰</h1>

    <a href="{% url 'patients:create' %}" 
       class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-sm font-medium">
      + Ø¥Ø¶Ø§ÙØ© Ù…Ø±ÙŠØ¶ Ø¬Ø¯ÙŠØ¯
    </a>
  </div>

  <!-- ğŸ” Ø£Ø¯ÙˆØ§Øª Ø§Ù„ØªØµÙÙŠØ© -->
  <div class="bg-white border border-gray-200 rounded-2xl p-5 shadow-sm mb-6 flex flex-col md:flex-row gap-4 md:items-center md:justify-between">
    <input type="text"
           x-model="searchQuery"
           placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ..."
           class="w-full md:w-1/3 border border-gray-300 rounded-lg px-3 py-2.5 text-sm focus:border-blue-500 focus:ring focus:ring-blue-100 outline-none">

    <div class="flex gap-2">
      <select x-model="genderFilter" class="border border-gray-300 rounded-lg px-3 py-2.5 text-sm focus:border-blue-500 focus:ring-blue-100">
        <option value="">ÙƒÙ„ Ø§Ù„Ù…Ø±Ø¶Ù‰</option>
        <option value="Ø°ÙƒØ±">Ø§Ù„Ø°ÙƒÙˆØ±</option>
        <option value="Ø£Ù†Ø«Ù‰">Ø§Ù„Ø¥Ù†Ø§Ø«</option>
      </select>

      <button @click="resetFilters"
              class="px-3 py-2 text-sm bg-gray-100 border border-gray-200 rounded-lg hover:bg-gray-200 transition">
        ğŸ”„ Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†
      </button>
    </div>
  </div>

  <!-- ğŸ“‹ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø±Ø¶Ù‰ -->
  <div class="bg-white shadow rounded-2xl overflow-hidden border border-gray-200">
    <table class="min-w-full text-sm text-right">
      <thead class="bg-gray-100 text-gray-700 text-xs uppercase">
        <tr>
          <th class="px-6 py-3">Ø§Ù„Ø§Ø³Ù…</th>
          <th class="px-6 py-3">Ø§Ù„Ø¹Ù…Ø±</th>
          <th class="px-6 py-3">Ø§Ù„Ø¬Ù†Ø³</th>
          <th class="px-6 py-3">Ø§Ù„Ù‡Ø§ØªÙ</th>
          <th class="px-6 py-3">Ø§Ù„ØªØ´Ø®ÙŠØµ</th>
          <th class="px-6 py-3">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
          <th class="px-6 py-3 text-center">Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡</th>
        </tr>
      </thead>

      <tbody class="divide-y divide-gray-100">
        <template x-for="p in filteredPatients()" :key="p.id">
          <tr class="hover:bg-gray-50 transition">
            <td class="px-6 py-3 font-medium text-gray-900" x-text="p.name"></td>
            <td class="px-6 py-3 text-gray-700" x-text="p.age"></td>
            <td class="px-6 py-3 text-gray-700" x-text="p.gender || 'â€”'"></td>
            <td class="px-6 py-3 text-gray-700" x-text="p.phone || 'â€”'"></td>
            <td class="px-6 py-3 text-gray-700" x-text="p.diagnosis || 'â€”'"></td>
            <td class="px-6 py-3 text-gray-500" x-text="formatDate(p.created_at)"></td>
            <td class="px-6 py-3 text-center">
              <div class="flex justify-center gap-2">
                <a :href="`/patients/${p.id}/view/`"
                   class="px-3 py-1 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 transition">
                  Ø¹Ø±Ø¶
                </a>
                <a :href="`/patients/${p.id}/delete/`"
                   class="px-3 py-1 bg-red-600 text-white rounded-md hover:bg-red-700 transition">
                  Ø­Ø°Ù
                </a>
              </div>
            </td>
          </tr>
        </template>

        <template x-if="filteredPatients().length === 0">
          <tr>
            <td colspan="7" class="px-6 py-4 text-center text-gray-500">
              Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ù…Ø·Ø§Ø¨Ù‚Ø©.
            </td>
          </tr>
        </template>
      </tbody>
    </table>
  </div>
</div>

<!-- âš™ï¸ Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØªØµÙÙŠØ© -->
<script>
function patientsList() {
  return {
    allPatients: {{ patients_json|safe }},
    searchQuery: '',
    genderFilter: '',

    init() {},

    resetFilters() {
      this.searchQuery = '';
      this.genderFilter = '';
    },

    filteredPatients() {
      const q = this.searchQuery.trim().toLowerCase();
      const g = this.genderFilter.trim().toLowerCase();

      return this.allPatients.filter(p => {
        const matchSearch =
          !q ||
          (p.name && p.name.toLowerCase().includes(q)) ||
          (p.phone && p.phone.toLowerCase().includes(q));

        const genderVal = (p.gender || '').trim().toLowerCase();
        const matchGender = !g || genderVal === g;

        return matchSearch && matchGender;
      });
    },

    formatDate(iso) {
      const d = new Date(iso);
      const options = { year: 'numeric', month: 'short', day: 'numeric' };
      // ğŸ‘‡ Ø§Ù„Ù†ØªÙŠØ¬Ø©: "Oct 24, 2025"
      return d.toLocaleDateString('en-US', options);
    }
  };
}
</script>


{% endblock %}
