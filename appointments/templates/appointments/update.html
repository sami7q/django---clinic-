{% extends 'base.html' %}
{% block content %}

<div 
  x-data="appointmentEditForm()" 
  x-init="init()" 
  class="max-w-2xl mx-auto mt-10 bg-white rounded-2xl shadow-xl border border-gray-100 p-8 space-y-8"
>
  <!-- ğŸ©º Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
  <header class="flex justify-between items-center border-b pb-3">
    <h1 class="text-2xl font-bold text-blue-700 flex items-center gap-2">
      âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ÙˆØ¹Ø¯
    </h1>
    <a href="{% url 'appointments:list' %}" 
       class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition text-sm font-medium">
      â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
    </a>
  </header>

  <!-- ğŸ§¾ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ -->
  <form method="POST" class="space-y-8">
    {% csrf_token %}

    <!-- ğŸ‘¤ Ø§Ù„Ù…Ø±ÙŠØ¶ -->
    <div>
      <label class="block text-gray-700 font-medium mb-1">ğŸ‘¤ Ø§Ø³Ù… Ø§Ù„Ù…Ø±ÙŠØ¶</label>
      <input type="text" value="{{ appointment.patient }}" readonly
             class="w-full bg-gray-50 border border-gray-200 rounded-lg px-3 py-2 text-sm text-gray-700 cursor-not-allowed shadow-inner">
    </div>

    <!-- ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ® -->
    <div>
      <label class="block text-gray-700 font-medium mb-2">ğŸ“… ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙˆØ¹Ø¯</label>
      <div class="flex gap-2 mb-4">
        <button type="button" @click="switchMode('month')"
                class="px-3 py-1.5 text-xs rounded-lg border transition font-medium"
                :class="mode==='month' ? 'bg-blue-600 text-white border-blue-600 shadow-sm' : 'border-gray-300 text-gray-700 hover:bg-blue-50'">
          Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±
        </button>
        <button type="button" @click="switchMode('next')"
                class="px-3 py-1.5 text-xs rounded-lg border transition font-medium"
                :class="mode==='next' ? 'bg-blue-600 text-white border-blue-600 shadow-sm' : 'border-gray-300 text-gray-700 hover:bg-blue-50'">
          Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù‚Ø§Ø¯Ù…
        </button>
      </div>

      <div class="grid grid-cols-3 gap-2">
        <template x-for="d in dates" :key="d">
          <button type="button"
                  @click="pickDate(d)"
                  class="p-2 rounded-lg border text-sm transition"
                  :class="selectedDate===d
                    ? 'bg-blue-100 border-blue-600 text-blue-700 font-semibold'
                    : 'border-gray-300 text-gray-700 hover:bg-blue-50'">
            <span x-text="new Date(d).toLocaleDateString('ar-EG',{weekday:'short',day:'numeric',month:'short'})"></span>
          </button>
        </template>
      </div>
      <input type="hidden" name="date" :value="selectedDate">
    </div>

    <!-- ğŸ•’ Ø§Ù„ÙˆÙ‚Øª -->
    <div>
      <label class="block text-gray-700 font-medium mb-2">ğŸ•’ ÙˆÙ‚Øª Ø§Ù„Ù…ÙˆØ¹Ø¯</label>
      <div class="grid grid-cols-6 gap-1.5">
        <template x-for="t in timeSlots" :key="t.value">
          <button type="button"
                  @click="selectedTime=t.value"
                  x-text="t.label"
                  :disabled="!t.available"
                  class="py-1 border rounded text-xs transition text-center"
                  :class="selectedTime===t.value
                    ? 'border-blue-600 bg-blue-100 text-blue-700 font-semibold'
                    : (t.available ? 'border-gray-300 text-gray-700 hover:bg-blue-50'
                                   : 'border-gray-200 text-gray-400 line-through cursor-not-allowed')">
          </button>
        </template>
      </div>
      <input type="hidden" name="time" :value="selectedTime">
    </div>

    <!-- ğŸ“ Ø§Ù„Ø³Ø¨Ø¨ -->
    <div>
      <label class="block text-gray-700 font-medium mb-2">ğŸ“ Ø³Ø¨Ø¨ Ø§Ù„Ø²ÙŠØ§Ø±Ø©</label>
      <textarea name="reason" rows="2"
                class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm resize-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500">{{ appointment.reason }}</textarea>
    </div>

    <!-- ğŸ“ Ø§Ù„Ø­Ø§Ù„Ø© -->
    <div>
      <label class="block text-gray-700 font-medium mb-2">ğŸ“ Ø§Ù„Ø­Ø§Ù„Ø©</label>
      {{ form.status }}
    </div>

    <!-- ğŸ’¾ Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
    <footer class="flex justify-end gap-3 border-t pt-4">
      <a href="{% url 'appointments:list' %}"
         class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition text-sm">
        Ø¥Ù„ØºØ§Ø¡
      </a>
      <button type="submit"
              class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-semibold shadow">
        ğŸ’¾ Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª
      </button>
    </footer>
  </form>
</div>

<script>
function appointmentEditForm() {
  return {
    mode: 'month',
    dates: [],
    selectedDate: '{{ appointment.date|date:"Y-m-d" }}',
    selectedTime: '{{ appointment.time|time:"H:i" }}',
    bookedByDate: JSON.parse('{{ booked_slots_json|escapejs }}'),
    timeSlots: [],
    init() {
      this.generateDates();
      this.generateTimeSlots();
      this.$watch('selectedDate', () => this.generateTimeSlots());
    },
    switchMode(mode) {
      this.mode = mode;
      this.generateDates();
    },
    pickDate(d) {
      this.selectedDate = d;
    },
    generateDates() {
      const now = new Date();
      const year = now.getFullYear();
      const month = this.mode === 'month' ? now.getMonth() : now.getMonth() + 1;
      const start = new Date(year, month, 1);
      const end = new Date(year, month + 1, 0);
      this.dates = [];
      for (let d = new Date(start); d <= end; d.setDate(d.getDate() + 1)) {
        const today = new Date();
        today.setHours(0,0,0,0);
        const check = new Date(d);
        check.setHours(0,0,0,0);
        if (check < today) continue;
        this.dates.push(d.toISOString().split('T')[0]);
      }
    },
    generateTimeSlots() {
      this.timeSlots = [];
      const now = new Date();
      const selected = new Date(this.selectedDate + 'T00:00:00');
      const sameDay = selected.toDateString() === now.toDateString();
      const bookedSet = new Set(this.bookedByDate[this.selectedDate] || []);
      for (let h = 9; h <= 18; h++) {
        for (let m = 0; m < 60; m += 30) {
          const hh = String(h).padStart(2, '0');
          const mm = m === 0 ? '00' : '30';
          const value = `${hh}:${mm}`;
          let available = true;
          if (sameDay) {
            const slot = new Date(this.selectedDate + `T${hh}:${mm}:00`);
            if (slot <= now) available = false;
          }
          if (bookedSet.has(value) && value !== this.selectedTime) available = false;
          this.timeSlots.push({ label: value, value, available });
        }
      }
    }
  };
}
</script>

{% endblock %}
