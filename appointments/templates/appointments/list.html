{% extends 'base.html' %}
{% block content %}

<div x-data="appointmentsList()" x-init="init()" class="p-8 max-w-6xl mx-auto bg-white rounded-3xl shadow-lg border border-gray-100">

  <!-- ๐งญ ุงูุนููุงู + ุงูุฃุฒุฑุงุฑ -->
  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 mb-8">
    <h1 class="text-2xl font-bold text-blue-800">
      {% if show_all %}๐ ุฌููุน ุงูููุงุนูุฏ{% else %}๐ ุงูููุงุนูุฏ ุงููุงุฏูุฉ{% endif %}
    </h1>

    <div class="flex gap-2">
      {% if not show_all %}
        <a href="{% url 'appointments:all' %}"
           class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg border hover:bg-gray-200 transition text-sm">
          ๐ ุฌููุน ุงูููุงุนูุฏ
        </a>
      {% else %}
        <a href="{% url 'appointments:list' %}"
           class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg border hover:bg-gray-200 transition text-sm">
          ๐ ุงูููุงุนูุฏ ุงููุงุฏูุฉ
        </a>
      {% endif %}
      <a href="{% url 'appointments:create' %}"
         class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 text-sm transition">
        + ุฅุถุงูุฉ ููุนุฏ
      </a>
    </div>
  </div>

  <!-- ๐ ุดุฑูุท ุงูููุชุฑุฉ -->
  <div class="bg-gray-50 rounded-2xl border border-gray-200 p-4 mb-6 flex flex-col md:flex-row gap-3 md:items-center md:justify-between">
    <input type="text"
           x-model="searchQuery"
           placeholder="๐ ุงุจุญุซ ุจุงูุงุณู ุฃู ุฑูู ุงููุงุชู..."
           class="w-full md:w-1/3 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-blue-500 focus:ring focus:ring-blue-100 outline-none">

    <div class="flex gap-2">
      <!-- โ ุงูุญุงูุงุช ุงูุฌุฏูุฏุฉ -->
      <select x-model="statusFilter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-blue-500 focus:ring-blue-100">
        <option value="">ูู ุงูุญุงูุงุช</option>
        <option value="ูู ูุญู ุงูููุนุฏ">๐ ูู ูุญู ุงูููุนุฏ</option>
        <option value="ุชูุช ุงูุฒูุงุฑุฉ">โ ุชูุช ุงูุฒูุงุฑุฉ</option>
        <option value="ุฃูุบูุช">โ ุฃูุบูุช</option>
      </select>

      <select x-model="dateFilter" class="border border-gray-300 rounded-lg px-3 py-2 text-sm focus:border-blue-500 focus:ring-blue-100">
        <option value="">ูู ุงูุฃูุงู</option>
        <option value="today">๐ ุงูููู</option>
        <option value="tomorrow">๐๏ธ ุบุฏูุง</option>
        <option value="week">๐ ูุฐุง ุงูุฃุณุจูุน</option>
        <option value="month">๐๏ธ ูุฐุง ุงูุดูุฑ</option>
      </select>
    </div>
  </div>

  <!-- ๐ ุฌุฏูู ุงูููุงุนูุฏ -->
  <div class="overflow-x-auto rounded-2xl border border-gray-200 bg-white">
    <table class="min-w-full text-sm text-gray-700">
      <thead class="bg-blue-50 text-blue-800 text-xs uppercase font-semibold border-b">
        <tr>
          <th class="px-5 py-3 text-right">ุงููุฑูุถ</th>
          <th class="px-5 py-3 text-right">ุงูุชุงุฑูุฎ</th>
          <th class="px-5 py-3 text-right">ุงูููุช</th>
          <th class="px-5 py-3 text-right">ุงูุญุงูุฉ</th>
          <th class="px-5 py-3 text-right">ุงูุณุจุจ</th>
          <th class="px-5 py-3 text-center">ุฅุฌุฑุงุกุงุช</th>
        </tr>
      </thead>
      <tbody>
        <template x-if="filteredAppointments().length > 0">
          <template x-for="appt in filteredAppointments()" :key="appt.id">
            <tr class="border-b hover:bg-blue-50/50 transition" :class="{'opacity-60': isPast(appt)}">
              <td class="px-5 py-3 font-semibold text-gray-800" x-text="appt.patient"></td>
              <td class="px-5 py-3" x-text="formatDate(appt.date)"></td>
              <td class="px-5 py-3" x-text="formatTime(appt.time)"></td>
              <td class="px-5 py-3">
                <span class="inline-flex items-center gap-1 text-xs font-semibold px-2.5 py-1 rounded-full border"
                      :class="statusClass(appt.status)">
                  <span class="w-2 h-2 rounded-full" :class="dotClass(appt.status)"></span>
                  <span x-text="appt.status"></span>
                </span>
              </td>
              <td class="px-5 py-3 text-gray-600 truncate max-w-[200px]" x-text="appt.reason || 'โ'"></td>
              <td class="px-5 py-3 text-center">
                <div class="flex justify-center gap-2">
                  <a :href="appt.edit_url"
                     class="px-3 py-1.5 bg-blue-500/10 text-blue-700 border border-blue-300 rounded-lg text-xs font-medium hover:bg-blue-500 hover:text-white transition">
                     โ๏ธ ุชุนุฏูู
                  </a>
                  <a :href="appt.delete_url"
                     class="px-3 py-1.5 bg-red-500/10 text-red-700 border border-red-300 rounded-lg text-xs font-medium hover:bg-red-500 hover:text-white transition">
                     ๐๏ธ ุญุฐู
                  </a>
                </div>
              </td>
            </tr>
          </template>
        </template>

        <template x-if="filteredAppointments().length === 0">
          <tr>
            <td colspan="6" class="text-center text-gray-500 py-6 text-sm">ูุง ุชูุฌุฏ ููุงุนูุฏ ูุทุงุจูุฉ ููุจุญุซ ุฃู ุงูููุงุชุฑ ุงูุญุงููุฉ.</td>
          </tr>
        </template>
      </tbody>
    </table>
  </div>
</div>

<!-- โ๏ธ ุณูุฑุจุช -->
<script>
function appointmentsList() {
  return {
    allAppointments: {{ appointments_json|safe }},
    searchQuery: '',
    statusFilter: '',
    dateFilter: '',
    now: new Date(),

    init() {
      this.allAppointments.sort((a, b) => this.toDateObj(a) - this.toDateObj(b));
    },

    normalizeTo24(timeStr) {
      if (!timeStr) return '00:00';
      const match = /^(\d{1,2}):(\d{2})\s*([AP]M)?$/i.exec(timeStr);
      if (!match) return timeStr;
      let [_, h, m, ampm] = match;
      h = parseInt(h);
      if (ampm) {
        ampm = ampm.toUpperCase();
        if (ampm === 'PM' && h !== 12) h += 12;
        if (ampm === 'AM' && h === 12) h = 0;
      }
      return `${String(h).padStart(2, '0')}:${m}`;
    },

    toDateObj(appt) {
      return new Date(`${appt.date}T${this.normalizeTo24(appt.time)}:00`);
    },

    isPast(appt) {
      return this.toDateObj(appt) < this.now;
    },

    formatDate(dateStr) {
      const d = new Date(dateStr);
      return `${d.getDate()}/${d.getMonth() + 1}/${d.getFullYear()}`;
    },

    formatTime(timeStr) {
      const [h, m] = this.normalizeTo24(timeStr).split(':');
      let hour = parseInt(h);
      const suffix = hour >= 12 ? 'ู' : 'ุต';
      if (hour > 12) hour -= 12;
      if (hour === 0) hour = 12;
      return `${hour}:${m} ${suffix}`;
    },

    // โ ุงูุญุงูุงุช ุงูุฌุฏูุฏุฉ
    statusClass(status) {
      if (status === 'ูู ูุญู ุงูููุนุฏ') return 'bg-blue-50 text-blue-800 border-blue-200';
      if (status === 'ุชูุช ุงูุฒูุงุฑุฉ') return 'bg-green-50 text-green-800 border-green-200';
      if (status === 'ุฃูุบูุช') return 'bg-red-50 text-red-800 border-red-200';
      return 'bg-gray-50 text-gray-700 border-gray-200';
    },

    dotClass(status) {
      if (status === 'ูู ูุญู ุงูููุนุฏ') return 'bg-blue-500';
      if (status === 'ุชูุช ุงูุฒูุงุฑุฉ') return 'bg-green-500';
      if (status === 'ุฃูุบูุช') return 'bg-red-500';
      return 'bg-gray-400';
    },

    filteredAppointments() {
      const q = this.searchQuery.trim().toLowerCase();
      return this.allAppointments.filter(a => {
        const apptDate = this.toDateObj(a);
        const matchSearch = !q || (a.patient && a.patient.toLowerCase().includes(q)) || (a.phone && String(a.phone).includes(q));
        const matchStatus = !this.statusFilter || a.status === this.statusFilter;
        let matchDate = true;

        // ุงูููู
        if (this.dateFilter === 'today') {
          const today = new Date(this.now.getFullYear(), this.now.getMonth(), this.now.getDate());
          matchDate = apptDate.toDateString() === today.toDateString();

        // ุบุฏูุง
        } else if (this.dateFilter === 'tomorrow') {
          const tomorrow = new Date(this.now);
          tomorrow.setDate(this.now.getDate() + 1);
          matchDate = apptDate.toDateString() === tomorrow.toDateString();

        // ูุฐุง ุงูุฃุณุจูุน
        } else if (this.dateFilter === 'week') {
          const start = new Date(this.now);
          const end = new Date(start);
          end.setDate(start.getDate() + 7);
          matchDate = apptDate >= start && apptDate < end;

        // ูุฐุง ุงูุดูุฑ
        } else if (this.dateFilter === 'month') {
          matchDate = apptDate.getMonth() === this.now.getMonth() && apptDate.getFullYear() === this.now.getFullYear();
        }

        return matchSearch && matchStatus && matchDate;
      });
    },
  };
}
</script>

{% endblock %}
