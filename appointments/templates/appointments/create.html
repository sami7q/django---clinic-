{% extends 'base.html' %}
{% block content %}

<div 
  x-data="appointmentForm()" 
  x-init="init()" 
  class="max-w-2xl mx-auto mt-10 bg-white rounded-2xl shadow-xl border border-gray-100 p-8 space-y-8"
>
  <!-- ğŸ©º Ø§Ù„Ø¹Ù†ÙˆØ§Ù† -->
  <header class="flex justify-between items-center">
    <h1 class="text-2xl font-bold text-blue-700">ğŸ“… Ø¥Ø¶Ø§ÙØ© Ù…ÙˆØ¹Ø¯ Ø¬Ø¯ÙŠØ¯</h1>
    <a href="{% url 'appointments:list' %}" 
       class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition">
      â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù‚Ø§Ø¦Ù…Ø©
    </a>
  </header>

  <!-- ğŸ§¾ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ -->
  <form method="POST" class="space-y-8">
    {% csrf_token %}

    <!-- ğŸ”¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù…Ø±ÙŠØ¶ -->
    {% include 'appointments/_patients_dropdown.html' %}

    <!-- ğŸ”¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø±ÙŠØ® -->
    {% include 'appointments/_date_picker.html' %}

    <!-- ğŸ”¹ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆÙ‚Øª -->
    <div>
      <label class="block text-gray-700 font-medium mb-1">Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙˆÙ‚Øª:</label>
      <div class="grid grid-cols-6 gap-1">
        <template x-for="t in timeSlots" :key="t.value">
          <button type="button"
                  class="p-1.5 border rounded text-xs hover:bg-blue-50 transition"
                  :disabled="!t.available"
                  :class="selectedTime === t.value
                           ? 'border-blue-600 text-blue-700 font-medium bg-blue-50'
                           : (t.available ? 'border-gray-300 text-gray-700' : 'border-gray-200 text-gray-400 line-through')"
                  @click="selectedTime = t.value"
                  x-text="t.label"></button>
        </template>
      </div>
      <input type="hidden" name="time" :value="selectedTime">
    </div>

    <!-- ğŸ”¹ Ø§Ù„Ø³Ø¨Ø¨ + Ø§Ù„Ø­Ø§Ù„Ø© -->
    <!-- ğŸ”¹ Ø§Ù„Ø³Ø¨Ø¨ + Ø§Ù„Ø­Ø§Ù„Ø© -->
<div class="mt-6 space-y-5">

  <!-- Ø³Ø¨Ø¨ Ø§Ù„Ø²ÙŠØ§Ø±Ø© -->
  <div>
    <label class="block text-gray-700 font-medium mb-2">Ø³Ø¨Ø¨ Ø§Ù„Ø²ÙŠØ§Ø±Ø©:</label>
    <textarea name="reason"
              class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm resize-none
                     focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition"
              rows="2">{{ form.reason.value|default_if_none:'' }}</textarea>
  </div>

  <!-- Ø§Ù„Ø­Ø§Ù„Ø© -->
  <div>
    <label class="block text-gray-700 font-medium mb-2">Ø§Ù„Ø­Ø§Ù„Ø©:</label>
    <div class="relative inline-block w-full">
      {{ form.status }}
    </div>
  </div>

</div>

<style>
  select[name="status"] {
    width: 100%;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    padding: 0.45rem 2rem 0.45rem 0.75rem;
    font-size: 0.875rem;
    background-color: #fff;
    color: #374151;
    transition: all 0.2s ease;
    appearance: none;
    background-image: linear-gradient(45deg, transparent 50%, #2563eb 50%),
                      linear-gradient(135deg, #2563eb 50%, transparent 50%);
    background-position: calc(100% - 16px) center, calc(100% - 11px) center;
    background-size: 5px 5px, 5px 5px;
    background-repeat: no-repeat;
    cursor: pointer;
  }

  select[name="status"]:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.25);
  }

  textarea[name="reason"] {
    resize: none;
  }
</style>


    <!-- ğŸ”¹ Ø§Ù„Ø£Ø²Ø±Ø§Ø± -->
    <div class="flex justify-end gap-3 pt-4">
      <a href="{% url 'appointments:list' %}" 
         class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition">
         Ø¥Ù„ØºØ§Ø¡
      </a>
      <button type="submit" 
              class="px-5 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition font-medium shadow-sm">
        ğŸ’¾ Ø­ÙØ¸ Ø§Ù„Ù…ÙˆØ¹Ø¯
      </button>
    </div>
  </form>
</div>

<!-- âš™ï¸ Ø³ÙƒØ±Ø¨Øª Alpine.js -->
<script>
function appointmentForm() {
  return {
    mode: 'month',
    dates: [],
    selectedDate: '',
    selectedTime: '',
    selectedPatient: '',
    timeSlots: [],
    bookedByDate: JSON.parse('{{ booked_slots_json|escapejs }}'),
    __initialized: false,

    init() {
      if (this.__initialized) return;
      this.__initialized = true;

      this.generateDates('month');
      if (this.dates.length > 0) this.selectedDate = this.dates[0];
      this.generateTimeSlots();

      this.$watch('selectedDate', () => {
        this.selectedTime = '';
        this.generateTimeSlots();
      });
    },

    handlePatientChange(e) {
      if (e.target.value === 'new') {
        window.open("{% url 'patients:create' %}", "_blank");
        e.target.value = '';
      }
    },

    switchMode(mode) {
      if (this.mode === mode) return;
      this.mode = mode;
      this.generateDates(mode);
      this.selectedTime = '';
      this.selectedDate = this.dates.length ? this.dates[0] : '';
      this.generateTimeSlots();
    },

    generateDates(mode) {
      this.dates = [];
      const now = new Date();
      const year = now.getFullYear();

      if (mode === 'month') {
        const month = now.getMonth();
        const today = now.getDate();
        const lastDay = new Date(year, month + 1, 0).getDate();
        for (let i = today; i <= lastDay; i++) {
          const d = new Date(year, month, i);
          this.dates.push(d.toISOString().split('T')[0]);
        }
      } else if (mode === 'next') {
        const nextMonth = now.getMonth() + 1;
        const lastDayNext = new Date(year, nextMonth + 1, 0).getDate();
        for (let i = 1; i <= lastDayNext; i++) {
          const d = new Date(year, nextMonth, i);
          this.dates.push(d.toISOString().split('T')[0]);
        }
      }
    },

    generateTimeSlots() {
      this.timeSlots = [];
      if (!this.selectedDate) return;

      const now = new Date();
      const selected = new Date(this.selectedDate + 'T00:00:00');
      const sameDay = selected.toDateString() === now.toDateString();
      const bookedSet = new Set(this.bookedByDate[this.selectedDate] || []);

      for (let hour = 9; hour <= 19; hour++) {
        for (let min = 0; min < 60; min += 30) {
          const hh = String(hour).padStart(2, '0');
          const mm = min === 0 ? '00' : '30';
          const value = `${hh}:${mm}`;
          let available = true;

          if (sameDay) {
            const slotDate = new Date(this.selectedDate + `T${hh}:${mm}:00`);
            if (slotDate <= now) available = false;
          }
          if (bookedSet.has(value)) available = false;

          this.timeSlots.push({ label: value, value, available });
        }
      }
    },

    pickDate(isoDate) {
      if (this.selectedDate === isoDate) return;
      this.selectedDate = isoDate;
    }
  };
}
</script>

<!-- ğŸ¨ ØªØ­Ø³ÙŠÙ† Ù…Ø¸Ù‡Ø± Ø§Ù„Ø­Ù‚ÙˆÙ„ (Ø¨Ø¯ÙˆÙ† Ø£ÙŠ Ù…ÙƒØªØ¨Ø§Øª) -->
<style>
  select, textarea, input[type="text"] {
    width: 100%;
    border: 1px solid #d1d5db;
    border-radius: 0.5rem;
    padding: 0.5rem 0.75rem;
    font-size: 0.9rem;
    background-color: #fff;
    color: #374151;
    transition: all 0.2s ease;
  }

  select:focus,
  textarea:focus,
  input[type="text"]:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.25);
  }

  select {
    appearance: none;
    background-image: linear-gradient(45deg, transparent 50%, #2563eb 50%), 
                      linear-gradient(135deg, #2563eb 50%, transparent 50%);
    background-position: calc(100% - 15px) calc(1em + 2px), calc(100% - 10px) calc(1em + 2px);
    background-size: 5px 5px, 5px 5px;
    background-repeat: no-repeat;
  }
</style>

{% endblock %}
